<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Markmap</title>
    <style>
      * {
        margin: 0;
        padding: 0;
      }
      #mindmap {
        display: block;
        width: 100vw;
        height: 100vh;
      }
    </style>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/markmap-toolbar@0.17.3-beta.4/dist/style.css"
    />
  </head>
  <body>
    <svg id="mindmap"></svg>
    <script src="https://cdn.jsdelivr.net/npm/d3@7.9.0/dist/d3.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/markmap-view@0.17.3-beta.4/dist/browser/index.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/markmap-toolbar@0.17.3-beta.4/dist/index.js"></script>
    <script>
      (() => {
        setTimeout(() => {
          const { markmap: k, mm: N } = window,
            U = new k.Toolbar();
          U.attach(N);
          const D = U.render();
          D.setAttribute('style', 'position:absolute;bottom:20px;right:20px'),
            document.body.append(D);
        });
      })();
    </script>
    <script>
      ((n, M, H, F) => {
        const G = n();
        window.mm = G.Markmap.create(
          'svg#mindmap',
          (M || G.deriveOptions)(F),
          H
        );
      })(
        () => window.markmap,
        null,
        {
          content: '3. Protocolos de Compromiso',
          children: [
            {
              content: '3.1. Compromiso en 2 Fases',
              children: [
                {
                  content: '3.1.1. Fase 1',
                  children: [
                    {
                      content: '1. \n<p data-lines="16,17">(C_i):</p>',
                      children: [
                        {
                          content: 'Añade a la bitácora.',
                          children: [],
                          payload: { lines: '17,18' },
                        },
                        {
                          content:
                            'Envía el mensaje <code>PREPARAR T</code> a todas las localidades participantes.',
                          children: [],
                          payload: { lines: '18,20' },
                        },
                      ],
                      payload: { lines: '16,20', listIndex: 1 },
                    },
                    {
                      content:
                        '2. \n<p data-lines="20,21">Cada gestor de transacciones:</p>',
                      children: [
                        {
                          content:
                            'Decide si puede ejecutar la parte de (T) que le corresponde.',
                          children: [],
                          payload: { lines: '21,22' },
                        },
                        {
                          content: 'Si no puede:',
                          children: [
                            {
                              content: 'Añade a la bitácora.',
                              children: [],
                              payload: { lines: '23,24' },
                            },
                            {
                              content:
                                'Envía a (C_i) el mensaje <code>ABORTAR T</code>.',
                              children: [],
                              payload: { lines: '24,25' },
                            },
                          ],
                          payload: { lines: '22,25' },
                        },
                        {
                          content: 'Si puede:',
                          children: [
                            {
                              content: 'Añade a la bitácora.',
                              children: [],
                              payload: { lines: '26,27' },
                            },
                            {
                              content:
                                'Graba los registros correspondientes de (T).',
                              children: [],
                              payload: { lines: '27,28' },
                            },
                            {
                              content:
                                'Envía a (C_i) el mensaje <code>T LISTA</code>.',
                              children: [],
                              payload: { lines: '28,30' },
                            },
                          ],
                          payload: { lines: '25,30' },
                        },
                      ],
                      payload: { lines: '20,30', listIndex: 2 },
                    },
                  ],
                  payload: { lines: '14,15' },
                },
                {
                  content: '3.1.2. Fase 2',
                  children: [
                    {
                      content:
                        '1. \n<p data-lines="34,35">Cuando todas las localidades han respondido:</p>',
                      children: [
                        {
                          content:
                            'Si (C_i) recibe <code>T LISTA</code> de todas las localidades:',
                          children: [
                            {
                              content: '(T) puede ejecutarse.',
                              children: [],
                              payload: { lines: '36,37' },
                            },
                            {
                              content: 'Añade a la bitácora.',
                              children: [],
                              payload: { lines: '37,38' },
                            },
                            {
                              content: 'Graba en memoria estable.',
                              children: [],
                              payload: { lines: '38,39' },
                            },
                            {
                              content:
                                'Envía el mensaje <code>EJECUTAR T</code> a todas las localidades participantes.',
                              children: [],
                              payload: { lines: '39,40' },
                            },
                          ],
                          payload: { lines: '35,40' },
                        },
                        {
                          content:
                            'Si no recibe <code>T LISTA</code> de todas:',
                          children: [
                            {
                              content: '(T) se aborta.',
                              children: [],
                              payload: { lines: '41,42' },
                            },
                            {
                              content:
                                'Añade a la bitácora y graba en memoria estable.',
                              children: [],
                              payload: { lines: '42,43' },
                            },
                            {
                              content:
                                'Envía el mensaje <code>ABORTAR T</code>.',
                              children: [],
                              payload: { lines: '43,45' },
                            },
                          ],
                          payload: { lines: '40,45' },
                        },
                      ],
                      payload: { lines: '34,45', listIndex: 1 },
                    },
                    {
                      content:
                        '2. \n<p data-lines="45,46">Las localidades:</p>',
                      children: [
                        {
                          content:
                            'Envían a (C_i) el mensaje <code>RECONOCIMIENTO T</code>.',
                          children: [],
                          payload: { lines: '46,47' },
                        },
                        {
                          content:
                            'Cuando (C_i) recibe todos los reconocimientos:',
                          children: [
                            {
                              content: 'Añade el estado final a la bitácora.',
                              children: [],
                              payload: { lines: '48,50' },
                            },
                          ],
                          payload: { lines: '47,50' },
                        },
                      ],
                      payload: { lines: '45,50', listIndex: 2 },
                    },
                  ],
                  payload: { lines: '32,33' },
                },
                {
                  content: '3.1.3. Conclusiones',
                  children: [
                    {
                      content:
                        '1. Una localidad puede <strong>abortar (T)</strong> de manera incondicional antes de enviar <code>T LISTA</code> a (C_i).',
                      children: [],
                      payload: { lines: '54,55', listIndex: 1 },
                    },
                    {
                      content:
                        '2. Enviar <code>T LISTA</code> es una <strong>promesa</strong> de cumplir la orden de (C_i) para ejecutar o abortar (T).',
                      children: [],
                      payload: { lines: '55,56', listIndex: 2 },
                    },
                    {
                      content:
                        '3. La promesa solo puede hacerse si la información requerida está en almacenamiento estable.',
                      children: [],
                      payload: { lines: '56,57', listIndex: 3 },
                    },
                    {
                      content:
                        '4. Se requiere <strong>unanimidad</strong> para ejecutar (T).',
                      children: [],
                      payload: { lines: '57,58', listIndex: 4 },
                    },
                    {
                      content:
                        '5. (C_i) puede abortar (T) de forma unilateral.',
                      children: [],
                      payload: { lines: '58,59', listIndex: 5 },
                    },
                    {
                      content:
                        '6. El destino de (T) se fija cuando (C_i) lo registra en la bitácora y lo graba en memoria estable.',
                      children: [],
                      payload: { lines: '59,61', listIndex: 6 },
                    },
                  ],
                  payload: { lines: '52,53' },
                },
              ],
              payload: { lines: '8,9' },
            },
            {
              content: '3.2. Manejo de Fallos',
              children: [
                {
                  content: '3.2.1. Fallo de una Localidad Participante',
                  children: [
                    {
                      content: '1. Cuando (L_k) se recupera:',
                      children: [
                        {
                          content: 'Examina su bitácora.',
                          children: [],
                          payload: { lines: '70,71' },
                        },
                        {
                          content:
                            'Si contiene <code>EJECUTAR T</code>, ejecuta <code>REHACER(T)</code>.',
                          children: [],
                          payload: { lines: '71,72' },
                        },
                        {
                          content:
                            'Si no contiene registros o contiene <code>ABORTAR T</code>, ejecuta <code>DESHACER(T)</code>.',
                          children: [],
                          payload: { lines: '72,73' },
                        },
                        {
                          content:
                            'Si contiene <code>T LISTA</code>, consulta a (C_i), que notificará el estado final de (T).',
                          children: [
                            {
                              content: 'Si (C_i) está inactivo:',
                              children: [
                                {
                                  content:
                                    'Envía un mensaje de consulta del estado de (T) a todas las localidades.',
                                  children: [],
                                  payload: { lines: '75,76' },
                                },
                                {
                                  content:
                                    'Las localidades consultan sus bitácoras y notifican a (L_k).',
                                  children: [],
                                  payload: { lines: '76,77' },
                                },
                                {
                                  content:
                                    'Si ninguna tiene información sobre (T), la decisión se pospone.',
                                  children: [],
                                  payload: { lines: '77,79' },
                                },
                              ],
                              payload: { lines: '74,79' },
                            },
                          ],
                          payload: { lines: '73,79' },
                        },
                      ],
                      payload: { lines: '69,79', listIndex: 1 },
                    },
                  ],
                  payload: { lines: '67,68' },
                },
                {
                  content: '3.2.2. Fallo del Coordinador ((C_i))',
                  children: [
                    {
                      content: '',
                      children: [
                        {
                          content:
                            '1. Si una localidad contiene <code>EJECUTAR T</code>, ejecuta (T).',
                          children: [],
                          payload: { lines: '83,84', listIndex: 1 },
                        },
                        {
                          content:
                            '2. Si una localidad contiene <code>ABORTAR T</code>, aborta (T).',
                          children: [],
                          payload: { lines: '84,85', listIndex: 2 },
                        },
                        {
                          content:
                            '3. Si una localidad no contiene <code>T LISTA</code>, (C_i) no pudo decidir ejecutar (T).',
                          children: [],
                          payload: { lines: '85,86', listIndex: 3 },
                        },
                        {
                          content:
                            '4. Si todas las localidades tienen <code>T LISTA</code> y nada más:',
                          children: [
                            {
                              content:
                                'No se puede determinar qué decisión tomó (C_i) hasta que se recupere.',
                              children: [],
                              payload: { lines: '87,89' },
                            },
                          ],
                          payload: { lines: '86,89', listIndex: 4 },
                        },
                      ],
                      payload: { lines: '83,89' },
                    },
                    {
                      content: '',
                      children: [
                        {
                          content: '(T) puede retener recursos del sistema.',
                          children: [],
                          payload: { lines: '91,92' },
                        },
                        {
                          content:
                            'Otras transacciones pueden estar esperando a (T).',
                          children: [],
                          payload: { lines: '92,93' },
                        },
                        {
                          content:
                            'Los datos pueden no estar disponibles ni en (C_i) ni en otras localidades.',
                          children: [],
                          payload: { lines: '93,94' },
                        },
                        {
                          content:
                            'El número de datos no disponibles aumenta cuanto más tiempo esté (C_i) caído.',
                          children: [],
                          payload: { lines: '94,96' },
                        },
                      ],
                      payload: { lines: '91,96' },
                    },
                  ],
                  payload: { lines: '81,82' },
                },
                {
                  content: '3.2.3. Fallo de una Línea de Comunicación',
                  children: [
                    {
                      content:
                        'Desde las localidades, el fallo parece ser de otras localidades.',
                      children: [],
                      payload: { lines: '100,101' },
                    },
                    {
                      content:
                        'Se puede aplicar el esquema de manejo de fallos explicado anteriormente.',
                      children: [],
                      payload: { lines: '101,103' },
                    },
                  ],
                  payload: { lines: '98,99' },
                },
                {
                  content: '3.2.4. Fragmentación de la Red',
                  children: [
                    {
                      content:
                        '1. \n<p data-lines="107,108"><strong>Coordinador y participantes quedan en un mismo fragmento</strong>:</p>',
                      children: [
                        {
                          content:
                            'El fallo no tiene efecto sobre el protocolo.',
                          children: [],
                          payload: { lines: '108,110' },
                        },
                      ],
                      payload: { lines: '107,110', listIndex: 1 },
                    },
                    {
                      content:
                        '2. \n<p data-lines="110,111"><strong>Coordinador y participantes quedan distribuidos en varios fragmentos</strong>:</p>',
                      children: [
                        {
                          content:
                            'Se pierden mensajes entre ellos, generando un fallo de líneas de comunicación.',
                          children: [],
                          payload: { lines: '111,112' },
                        },
                      ],
                      payload: { lines: '110,112', listIndex: 2 },
                    },
                  ],
                  payload: { lines: '105,106' },
                },
              ],
              payload: { lines: '63,64' },
            },
          ],
          payload: { lines: '2,3' },
        },
        { colorFreezeLevel: 2 }
      );
    </script>
    <script>
      (() => {
        const { markmap: Markmap } = window;
        const svg = document.querySelector('#mindmap');
        const markmapInstance = Markmap.create(svg, null, {
          content: 'Contenido de tu mindmap aquí',
        });

        // Añadir zoom y pan
        const zoom = d3
          .zoom()
          .scaleExtent([0.5, 5]) // Limita el zoom (mínimo 0.5x y máximo 5x)
          .on('zoom', (event) => {
            svg.setAttribute('transform', event.transform);
          });

        d3.select(svg).call(zoom);
      })();
    </script>
  </body>
</html>
